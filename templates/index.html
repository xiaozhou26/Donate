<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>支付网关 URL 列表</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .table th, .table td {
            vertical-align: middle;
        }
        .sortable:hover {
            cursor: pointer;
            text-decoration: underline;
        }
        .dropdown-item:hover {
            cursor: pointer;
            background-color: #f8f9fa;
        }
        .pagination {
            justify-content: center;
        }
        .announcement {
            background-color: #f0f8ff; /* 柔和的背景颜色 */
            border-radius: 10px; /* 圆角边框 */
            padding: 20px; /* 内部填充 */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* 轻微的阴影效果 */
        }

        .announcement h4 {
            text-align: center; /* 将标题居中对齐 */
            color: #007bff; /* 标题的颜色 */
            font-weight: bold; /* 加粗标题 */
            margin-bottom: 15px; /* 标题底部间距 */
        }

        .announcement p {
            color: #333; /* 正文字体颜色 */
            font-size: 16px; /* 正文字体大小 */
            line-height: 1.6; /* 行高 */
        }
        .table td a {
            display: block;
            word-wrap: break-word; /* 允许在单词内换行 */
            word-break: break-all; /* 在必要时打断长单词换行 */
            max-width: 200px; /* 可选：设置最大宽度以便在这宽度内换行 */
            white-space: normal; /* 允许正常的文本换行 */
        }


    </style>
</head>
<body>
    <div class="container">
        <!-- Announcement Section -->
        <div class="announcement mt-4">
            <h4 class="mb-2">公告</h4>
            <hr> <!-- 分割线增加视觉效果 -->
            <p>有用的url请点赞，没有用的请点踩，感谢大家配合。</p>
            <p>Useful URLs, please like them, useless ones, please dislike them, thank you all for your cooperation.</p>
        </div>
        

        <h1 class="mt-5 mb-4 text-center">支付网关 URL 列表</h1>
        
        <table class="table table-bordered table-hover">
            <thead class="thead-light">
                <tr>
                    <th>序号</th>
                    <th>URL</th>
                    <th class="dropdown">
                        <a class="dropdown-toggle" href="#" role="button" id="dropdownGateways" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            支付网关
                        </a>
                        <div class="dropdown-menu" aria-labelledby="dropdownGateways">
                            <a class="dropdown-item" onclick="filterTable('gateways', '')">全部</a>
                            <a class="dropdown-item" onclick="filterTable('gateways', 'paypal')">PayPal</a>
                            <a class="dropdown-item" onclick="filterTable('gateways', 'stripe')">Stripe</a>
                            <a class="dropdown-item" onclick="filterTable('gateways', 'braintree')">Braintree</a>
                            <a class="dropdown-item" onclick="filterTable('gateways', 'checkout.com')">Checkout.com</a>
                            <a class="dropdown-item" onclick="filterTable('gateways', 'square')">Square</a>
                            <a class="dropdown-item" onclick="filterTable('gateways', 'woocommerce')">WooCommerce</a>
                            <a class="dropdown-item" onclick="filterTable('gateways', 'shopify')">Shopify</a>
                            <a class="dropdown-item" onclick="filterTable('gateways', 'authorize.net')">Authorize.Net</a>
                            <a class="dropdown-item" onclick="filterTable('gateways', 'adyen')">Adyen</a>
                            <a class="dropdown-item" onclick="filterTable('gateways', 'sagepay')">SagePay</a>
                        </div>
                    </th>
                    <th class="dropdown">
                        <a class="dropdown-toggle" href="#" role="button" id="dropdownCaptcha" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            验证码
                        </a>
                        <div class="dropdown-menu" aria-labelledby="dropdownCaptcha">
                            <a class="dropdown-item" onclick="filterTable('captcha', '')">全部</a>
                            <a class="dropdown-item" onclick="filterTable('captcha', 'Yes')">是</a>
                            <a class="dropdown-item" onclick="filterTable('captcha', 'No')">否</a>
                        </div>
                    </th>
                    <th class="dropdown">
                        <a class="dropdown-toggle" href="#" role="button" id="dropdownCloudflare" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Cloudflare
                        </a>
                        <div class="dropdown-menu" aria-labelledby="dropdownCloudflare">
                            <a class="dropdown-item" onclick="filterTable('cloudflare', '')">全部</a>
                            <a class="dropdown-item" onclick="filterTable('cloudflare', 'Yes')">是</a>
                            <a class="dropdown-item" onclick="filterTable('cloudflare', 'No')">否</a>
                        </div>
                    </th>
                    <th class="sortable" onclick="sortTable(5)">点赞</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="url-table">
                {% for url, data in url_data.items() %}
                    <tr>
                        <td>{{ loop.index + (page - 1) * 40 }}</td>
                        <td><a href="{{ url }}" target="_blank">{{ url }}</a></td>
                        <td>{{ data.gateways }}</td>
                        <td>{{ data.captcha }}</td>
                        <td>{{ data.cloudflare }}</td>
                        <td id="weight-{{ loop.index0 }}">{{ data.weight }}</td>
                        <td>
                            <button class="btn btn-success" onclick="updateWeight('{{ url }}', {{ loop.index0 }}, 1)">点赞</button>
                            <button class="btn btn-danger" onclick="updateWeight('{{ url }}', {{ loop.index0 }}, -1)">点踩</button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <nav aria-label="Page navigation">
            <ul class="pagination">
                {% if page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('index', page=page-1) }}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                {% endif %}
                {% for p in range(1, total_pages + 1) %}
                    <li class="page-item {% if p == page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('index', page=p) }}">{{ p }}</a>
                    </li>
                {% endfor %}
                {% if page < total_pages %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('index', page=page+1) }}" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>

    <script>
        const socket = io();

        function updateWeight(url, index, delta) {
            fetch('/update_weight', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `url=${encodeURIComponent(url)}&delta=${delta}`
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById(`weight-${index}`).innerText = data.weight;
            })
            .catch(error => console.error('Error:', error));
        }

        socket.on('new_url', function(data) {
            const table = document.getElementById('url-table');
            const index = table.rows.length;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td><a href="${data.url}" target="_blank">${data.url}</a></td>
                <td>${data.gateways}</td>
                <td>${data.captcha === 'Yes' ? '是' : '否'}</td>
                <td>${data.cloudflare === 'Yes' ? '是' : '否'}</td>
                <td id="weight-${index}">${data.weight}</td>
                <td>
                    <button class="btn btn-success" onclick="updateWeight('${data.url}', ${index}, 1)">点赞</button>
                    <button class="btn btn-danger" onclick="updateWeight('${data.url}', ${index}, -1)">点踩</button>
                </td>
            `;
            table.appendChild(row);
        });

        function filterTable(column, value) {
            const table = document.getElementById('url-table');
            const rows = table.getElementsByTagName('tr');
            let columnIndex;

            if (column === 'gateways') {
                columnIndex = 2;
            } else if (column === 'captcha') {
                columnIndex = 3;
            } else if (column === 'cloudflare') {
                columnIndex = 4;
            }

            for (let i = 0; i < rows.length; i++) {
                const cell = rows[i].getElementsByTagName('td')[columnIndex];
                if (cell) {
                    const text = cell.textContent || cell.innerText;
                    if (value === "" || text.toLowerCase().includes(value.toLowerCase())) {
                        rows[i].style.display = "";
                    } else {
                        rows[i].style.display = "none";
                    }
                }
            }
        }

        function sortTable(columnIndex) {
            const table = document.getElementById('url-table');
            const rows = Array.from(table.rows);
            
            const sortedRows = rows.sort((a, b) => {
                const cellA = a.getElementsByTagName('td')[columnIndex].innerText;
                const cellB = b.getElementsByTagName('td')[columnIndex].innerText;
                return parseInt(cellB) - parseInt(cellA);
            });

            table.innerHTML = '';
            sortedRows.forEach(row => table.appendChild(row));
        }
    </script>
</body>
</html>
