<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Gateway URL List</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .table th, .table td {
            vertical-align: middle;
        }
        .sortable:hover {
            cursor: pointer;
            text-decoration: underline;
        }
        .dropdown-item:hover {
            cursor: pointer;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mt-5 mb-4 text-center">Payment Gateway URL List</h1>
        
        <table class="table table-bordered table-hover">
            <thead class="thead-light">
                <tr>
                    <th>URL</th>
                    <th class="dropdown">
                        <a class="dropdown-toggle" href="#" role="button" id="dropdownGateways" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Gateways
                        </a>
                        <div class="dropdown-menu" aria-labelledby="dropdownGateways">
                            <a class="dropdown-item" onclick="filterTable('gateways', '')">All</a>
                            <a class="dropdown-item" onclick="filterTable('gateways', 'paypal')">PayPal</a>
                            <a class="dropdown-item" onclick="filterTable('gateways', 'stripe')">Stripe</a>
                            <a class="dropdown-item" onclick="filterTable('gateways', 'braintree')">Braintree</a>
                            <a class="dropdown-item" onclick="filterTable('gateways', 'checkout.com')">Checkout.com</a>
                            <a class="dropdown-item" onclick="filterTable('gateways', 'square')">Square</a>
                            <a class="dropdown-item" onclick="filterTable('gateways', 'woocommerce')">WooCommerce</a>
                            <a class="dropdown-item" onclick="filterTable('gateways', 'shopify')">Shopify</a>
                            <a class="dropdown-item" onclick="filterTable('gateways', 'authorize.net')">Authorize.Net</a>
                            <a class="dropdown-item" onclick="filterTable('gateways', 'adyen')">Adyen</a>
                            <a class="dropdown-item" onclick="filterTable('gateways', 'sagepay')">SagePay</a>
                        </div>
                    </th>
                    <th class="dropdown">
                        <a class="dropdown-toggle" href="#" role="button" id="dropdownCaptcha" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Captcha
                        </a>
                        <div class="dropdown-menu" aria-labelledby="dropdownCaptcha">
                            <a class="dropdown-item" onclick="filterTable('captcha', '')">All</a>
                            <a class="dropdown-item" onclick="filterTable('captcha', 'Yes')">Yes</a>
                            <a class="dropdown-item" onclick="filterTable('captcha', 'No')">No</a>
                        </div>
                    </th>
                    <th class="dropdown">
                        <a class="dropdown-toggle" href="#" role="button" id="dropdownCloudflare" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Cloudflare
                        </a>
                        <div class="dropdown-menu" aria-labelledby="dropdownCloudflare">
                            <a class="dropdown-item" onclick="filterTable('cloudflare', '')">All</a>
                            <a class="dropdown-item" onclick="filterTable('cloudflare', 'Yes')">Yes</a>
                            <a class="dropdown-item" onclick="filterTable('cloudflare', 'No')">No</a>
                        </div>
                    </th>
                    <th class="sortable" onclick="sortTable('likes')">Likes</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="url-table">
                {% for url, data in url_data.items() %}
                    <tr>
                        <td><a href="{{ url }}" target="_blank">{{ url }}</a></td>
                        <td>{{ data.gateways }}</td>
                        <td>{{ 'Yes' if 'captcha' in data.gateways else 'No' }}</td>
                        <td>{{ 'Yes' if 'cloudflare' in data.gateways else 'No' }}</td>
                        <td id="weight-{{ loop.index0 }}">{{ data.weight }}</td>
                        <td>
                            <button class="btn btn-success" onclick="updateWeight('{{ url }}', {{ loop.index0 }}, 1)">Like</button>
                            <button class="btn btn-danger" onclick="updateWeight('{{ url }}', {{ loop.index0 }}, -1)">Dislike</button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        const socket = io();

        function updateWeight(url, index, delta) {
            fetch('/update_weight', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `url=${encodeURIComponent(url)}&delta=${delta}`
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById(`weight-${index}`).innerText = data.weight;
            })
            .catch(error => console.error('Error:', error));
        }

        socket.on('new_url', function(data) {
            const table = document.getElementById('url-table');
            const row = document.createElement('tr');

            row.innerHTML = `
                <td><a href="${data.url}" target="_blank">${data.url}</a></td>
                <td>${data.gateways}</td>
                <td>${data.captcha}</td>
                <td>${data.cloudflare}</td>
                <td id="weight-${table.rows.length}">${data.weight}</td>
                <td>
                    <button class="btn btn-success" onclick="updateWeight('${data.url}', ${table.rows.length}, 1)">Like</button>
                    <button class="btn btn-danger" onclick="updateWeight('${data.url}', ${table.rows.length}, -1)">Dislike</button>
                </td>
            `;

            table.appendChild(row);
        });

        function filterTable(column, value) {
            const table = document.getElementById('url-table');
            const rows = table.getElementsByTagName('tr');
            let columnIndex;

            if (column === 'gateways') {
                columnIndex = 1;
            } else if (column === 'captcha') {
                columnIndex = 2;
            } else if (column === 'cloudflare') {
                columnIndex = 3;
            }

            for (let i = 0; i < rows.length; i++) {
                const cell = rows[i].getElementsByTagName('td')[columnIndex];
                if (cell) {
                    const text = cell.textContent || cell.innerText;
                    if (value === "" || text.toLowerCase().includes(value.toLowerCase())) {
                        rows[i].style.display = "";
                    } else {
                        rows[i].style.display = "none";
                    }
                }
            }
        }

        function sortTable(column) {
            const table = document.getElementById('url-table');
            const rows = Array.from(table.rows);
            let columnIndex;

            if (column === 'likes') {
                columnIndex = 4;
            } else {
                return;
            }

            const sortedRows = rows.sort((a, b) => {
                const cellA = a.getElementsByTagName('td')[columnIndex].innerText;
                const cellB = b.getElementsByTagName('td')[columnIndex].innerText;

                return parseInt(cellB) - parseInt(cellA);
            });

            table.innerHTML = '';
            sortedRows.forEach(row => table.appendChild(row));
        }
    </script>
</body>
</html>
